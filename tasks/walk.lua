local plugin_label = 'azmodan_farm' 
local utils = require "core.utils"
local tracker = require "core.tracker"

local status_enum = {
    IDLE = 'idle'
}

local task = {
    name = 'walk', 
    status = status_enum['IDLE']
}

-- Target fight center
local fight_center = vec3:new(-217.622, 616.873, 22)

-- Path from Zarbinzet portal to the fighting area
local path = {
    vec3:new(-238.117188, 386.241211, 52.762695),
    vec3:new(-239.066010, 388.562531, 52.710041),
    vec3:new(-239.987457, 390.949738, 52.713589),
    vec3:new(-240.779190, 393.345215, 52.831779),
    vec3:new(-241.457260, 395.771790, 53.071484),
    vec3:new(-242.055771, 398.220062, 53.225754),
    vec3:new(-242.404785, 400.712250, 53.824848),
    vec3:new(-242.869934, 403.190796, 54.651390),
    vec3:new(-243.456390, 405.647186, 54.894283),
    vec3:new(-244.561646, 407.942169, 55.268204),
    vec3:new(-245.590683, 410.238251, 55.241856),
    vec3:new(-247.773788, 411.574829, 55.239269),
    vec3:new(-250.083939, 412.546387, 55.525120),
    vec3:new(-252.403397, 413.511658, 55.796806),
    vec3:new(-254.721848, 414.469299, 55.695770),
    vec3:new(-257.001190, 415.513214, 55.565132),
    vec3:new(-259.110535, 416.855194, 55.370392),
    vec3:new(-261.083344, 418.401337, 55.358963),
    vec3:new(-263.306396, 419.564819, 54.774971),
    vec3:new(-265.534729, 420.732910, 54.065041),
    vec3:new(-267.638031, 422.106750, 53.514202),
    vec3:new(-269.705414, 423.529266, 52.655354),
    vec3:new(-271.867432, 424.824432, 51.895138),
    vec3:new(-274.057861, 426.081543, 51.298828),
    vec3:new(-276.247528, 427.337738, 50.583817),
    vec3:new(-278.592896, 428.367401, 49.916435),
    vec3:new(-280.881744, 429.382355, 49.276047),
    vec3:new(-283.199554, 430.351898, 48.590099),
    vec3:new(-285.464752, 431.427124, 47.861160),
    vec3:new(-287.717316, 432.651886, 47.069805),
    vec3:new(-289.768982, 434.160004, 46.232784),
    vec3:new(-291.837860, 435.643158, 45.468151),
    vec3:new(-293.806274, 437.203125, 44.858124),
    vec3:new(-295.738007, 438.814148, 44.456486),
    vec3:new(-297.531738, 440.571289, 44.426090),
    vec3:new(-299.182251, 442.465729, 44.297150),
    vec3:new(-300.047729, 444.868744, 43.874008),
    vec3:new(-300.659821, 447.356232, 43.243572),
    vec3:new(-301.359833, 449.772430, 42.445255),
    vec3:new(-302.114960, 452.191498, 41.702206),
    vec3:new(-302.703857, 454.643372, 41.022366),
    vec3:new(-303.004028, 457.156036, 40.276409),
    vec3:new(-303.133850, 459.679535, 39.778648),
    vec3:new(-303.187988, 462.202942, 39.582481),
    vec3:new(-303.205048, 464.726837, 39.558987),
    vec3:new(-303.171844, 467.250641, 39.294228),
    vec3:new(-303.156189, 469.777069, 39.231750),
    vec3:new(-303.145050, 472.297394, 39.039379),
    vec3:new(-303.161652, 474.820953, 38.777134),
    vec3:new(-303.147430, 477.345734, 38.343529),
    vec3:new(-303.114227, 479.868805, 37.814594),
    vec3:new(-303.077118, 482.392181, 37.270077),
    vec3:new(-303.028259, 484.915833, 36.708931),
    vec3:new(-302.899719, 487.439514, 36.154457),
    vec3:new(-302.646088, 489.960175, 35.750343),
    vec3:new(-302.130219, 492.435211, 34.950256),
    vec3:new(-301.509491, 494.890076, 34.165894),
    vec3:new(-300.818970, 497.329071, 33.456417),
    vec3:new(-300.059143, 499.746368, 32.748508),
    vec3:new(-299.213745, 502.131409, 32.373203),
    vec3:new(-298.243317, 504.467834, 32.021706),
    vec3:new(-297.221191, 506.791626, 31.832886),
    vec3:new(-295.743530, 508.843506, 31.382923),
    vec3:new(-293.858978, 510.539612, 31.546328),
    vec3:new(-291.778259, 511.992920, 31.360767),
    vec3:new(-289.686768, 513.437073, 31.092302),
    vec3:new(-287.588104, 514.852600, 31.006866),
    vec3:new(-285.498688, 516.287048, 30.628233),
    vec3:new(-283.493073, 517.838318, 30.051275),
    vec3:new(-281.618866, 519.543640, 29.321280),
    vec3:new(-279.831848, 521.330505, 28.603689),
    vec3:new(-278.280487, 523.328491, 27.864691),
    vec3:new(-276.864777, 525.437012, 26.981764),
    vec3:new(-275.651733, 527.656921, 26.568527),
    vec3:new(-275.410950, 530.162842, 26.271759),
    vec3:new(-275.764435, 532.657104, 26.428808),
    vec3:new(-276.413177, 535.105591, 25.949697),
    vec3:new(-276.912781, 537.580200, 25.790756),
    vec3:new(-277.466705, 540.047729, 25.693577),
    vec3:new(-278.122437, 542.490417, 25.656141),
    vec3:new(-278.720367, 544.945312, 24.914484),
    vec3:new(-279.391022, 547.380493, 24.551048),
    vec3:new(-280.260925, 549.749084, 24.147449),
    vec3:new(-281.021240, 552.160889, 23.415792),
    vec3:new(-281.612366, 554.620361, 23.307022),
    vec3:new(-281.763855, 557.137939, 23.578857),
    vec3:new(-281.643951, 559.661438, 23.844526),
    vec3:new(-281.302856, 562.176453, 23.293077),
    vec3:new(-280.116669, 564.395203, 23.248222),
    vec3:new(-278.317535, 566.175720, 23.233015),
    vec3:new(-276.356476, 567.785400, 23.126232),
    vec3:new(-274.383209, 569.373413, 23.553106),
    vec3:new(-272.418243, 570.980896, 23.862118),
    vec3:new(-270.471313, 572.605835, 23.579735),
    vec3:new(-268.662201, 574.395752, 23.481638),
    vec3:new(-266.942078, 576.250183, 23.989527),
    vec3:new(-265.231964, 578.109741, 23.685835),
    vec3:new(-263.485352, 579.950134, 23.458485),
    vec3:new(-261.688995, 581.742371, 22.738150),
    vec3:new(-259.843414, 583.491638, 21.903082),
    vec3:new(-257.955017, 585.181152, 21.419283),
    vec3:new(-256.034241, 586.841919, 21.880777),
    vec3:new(-254.081009, 588.464966, 22.170591),
    vec3:new(-252.121399, 590.075867, 21.999935),
    vec3:new(-250.162491, 591.686157, 22.000000),
    vec3:new(-248.203369, 593.296631, 22.000000),
    vec3:new(-246.244034, 594.907288, 22.000000),
    vec3:new(-244.284683, 596.517883, 22.000000),
    vec3:new(-242.357162, 598.177246, 22.000000),
    vec3:new(-240.398239, 599.822632, 22.000000),
    vec3:new(-238.442459, 601.441956, 22.000000),
    vec3:new(-236.500076, 603.048401, 22.000000),
    vec3:new(-234.557816, 604.656555, 22.000000),
    vec3:new(-232.581757, 606.223328, 22.000000),
    vec3:new(-230.489410, 607.668091, 22.000000),
    vec3:new(-228.397705, 609.112366, 22.000000),
    vec3:new(-226.303391, 610.558411, 22.000000),
    vec3:new(-224.211426, 612.002869, 22.000000),
    vec3:new(-222.119202, 613.447510, 22.000000),
    vec3:new(-220.016922, 614.879028, 22.000000),
    vec3:new(-218.126999, 616.616455, 22.000000),
}

local function get_azmodan_enemy()
    local player_pos = get_player_position()
    local enemies = target_selector.get_near_target_list(player_pos, 15)
    for _, enemy in pairs(enemies) do
        if enemy.get_skin_name(enemy) == 'Azmodan_EventBoss' then
            return enemy
        end
    end
    return nil
end

function task.shouldExecute()
    -- Recovery Check: If we are far from the boss regardless of zone
    local needs_recovery = utils.distance_to(fight_center) > 25
    
    -- Priority Check: Don't walk if Alfred is busy
    local alfred_busy = tracker.is_stashing or tracker.is_selling or tracker.is_depositing
    
    return needs_recovery and not alfred_busy and get_azmodan_enemy() == nil
end

function task.Execute()
    -- Ensure Orbwalker doesn't lock movement for combat
    if orbwalker.get_orb_mode() == 3 then
        orbwalker.set_clear_toggle(false)
    end

    local closest_distance = nil
    local closest_key = nil
    
    -- Identify the nearest breadcrumb
    for key, point in pairs(path) do
        local dist = utils.distance_to(point)
        if closest_distance == nil or dist < closest_distance then
            closest_distance = dist
            closest_key = key
        end
    end

    -- Pathfind by moving ahead in the coordinate sequence
    local target_point = path[closest_key + 2] or path[closest_key + 1] or fight_center
    if target_point then
        pathfinder.request_move(target_point)
    end
end

return task
